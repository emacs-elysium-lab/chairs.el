name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Minimal, consistent package init used by EVERY Emacs call
  ELCI: |
    (setq package-enable-at-startup nil
          package-quickstart nil
          package-check-signature nil
          package-user-dir (expand-file-name ".elpa" default-directory))
    (require 'package)
    (add-to-list 'package-archives '("gnu"   . "https://elpa.gnu.org/packages/") t)
    (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
    (package-initialize)
    ;; Ensure installed packages are actually on `load-path`
    (when (fboundp 'package-activate-all)
      (package-activate-all))
  # Install deps (assumes ELCI already eval'd in the same process)
  INSTALL_DEPS: |
    (unless (package-installed-p 'expand-region)
      (package-refresh-contents)
      (package-install 'expand-region))

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs_version: ['29.4', '30.1', 'snapshot']
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Cache ELPA
        uses: actions/cache@v4
        with:
          path: .elpa
          key: ${{ runner.os }}-elpa-${{ matrix.emacs_version }}
          restore-keys: |
            ${{ runner.os }}-elpa-

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs_version }}

      - name: Install dependencies (expand-region)
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "$INSTALL_DEPS" \
            --eval "(message \"expand-region at: %s\" (or (locate-library \"expand-region\") \"<nil>\"))"

      - name: Run tests
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "(or (require 'expand-region nil t) (error \"expand-region missing\"))" \
            -L . \
            -l ert \
            -l chairs.el \
            -l chairs-test.el \
            -f ert-run-tests-batch-and-exit

      - name: Byte compile
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "(or (require 'expand-region nil t) (error \"expand-region missing\"))" \
            --eval "(setq byte-compile-error-on-warn t)" \
            -L . \
            -f batch-byte-compile chairs.el

      - name: Check package install of chairs.el
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install-file \"chairs.el\")"
