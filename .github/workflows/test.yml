name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # Bootstrap used in EVERY Emacs invocation
  ELCI: |
    (setq package-enable-at-startup nil
          package-quickstart nil
          package-check-signature nil
          package-user-dir (expand-file-name ".elpa" default-directory))
    (require 'package)
    (add-to-list 'package-archives '("gnu"   . "https://elpa.gnu.org/packages/") t)
    (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
    (package-initialize)
    (when (fboundp 'package-activate-all)
      (package-activate-all))

  # Ensure expand-region is installed, activated, and loadable
  ENSURE_ER: |
    (let ((pkg 'expand-region))
      (unless (package-installed-p pkg)
        (package-refresh-contents)
        (package-install pkg))
      ;; activate + require; if anything odd, nuke cache and retry once
      (condition-case err
          (progn (when (fboundp 'package-activate) (package-activate pkg))
                 (require pkg))
        (error
         (when (file-directory-p package-user-dir)
           (delete-directory package-user-dir t))
         (package-refresh-contents)
         (package-install pkg)
         (when (fboundp 'package-activate) (package-activate pkg))
         (require pkg))))
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs_version: ['29.4', '30.1', 'snapshot']
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Cache ELPA
        uses: actions/cache@v4
        with:
          path: .elpa
          key: ${{ runner.os }}-elpa-${{ matrix.emacs_version }}-${{ hashFiles('.github/workflows/**') }}
          restore-keys: |
            ${{ runner.os }}-elpa-

      - name: Set up Emacs
        uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs_version }}

      - name: Sanity (where is expand-region?)
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "$ENSURE_ER" \
            --eval "(message \"expand-region at: %s\" (locate-library \"expand-region\"))"

      - name: Run tests
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "$ENSURE_ER" \
            -L . \
            -l ert \
            -l chairs.el \
            -l chairs-test.el \
            -f ert-run-tests-batch-and-exit

      - name: Byte compile (warnings are errors)
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "$ENSURE_ER" \
            --eval "(setq byte-compile-error-on-warn t)" \
            -L . \
            -f batch-byte-compile chairs.el

      - name: Check package install of chairs.el
        run: |
          emacs -Q --batch \
            --eval "$ELCI" \
            --eval "$ENSURE_ER" \
            --eval "(package-install-file \"chairs.el\")" \
            --eval "(message \"Installed chairs from file OK\")"
